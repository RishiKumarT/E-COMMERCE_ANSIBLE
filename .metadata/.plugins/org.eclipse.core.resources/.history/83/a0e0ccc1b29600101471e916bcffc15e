@Service
public class ProductService {

    @Autowired
    private ProductRepository productRepository;

    @Autowired
    private UserService userService;

    @Autowired
    private CategoryRepository categoryRepository;

    // Seller adds product under category
    public Product addProduct(Long requesterId, Long categoryId, Product product) {
        User requester = userService.getUserById(requesterId);

        if (requester.getRole() == User.Role.SELLER) {
            return addProductAsSeller(requesterId, categoryId, product);
        } else if (requester.getRole() == User.Role.ADMIN) {
            throw new RuntimeException("Admin must specify sellerId to add product on behalf of seller.");
        } else {
            throw new RuntimeException("Only SELLER or ADMIN can add products!");
        }
    }

    public Product addProductAsSeller(Long sellerId, Long categoryId, Product product) {
        User seller = userService.getUserById(sellerId);
        if (seller.getRole() != User.Role.SELLER) throw new RuntimeException("Not a seller");

        Category category = categoryRepository.findById(categoryId)
                .orElseThrow(() -> new RuntimeException("Category not found"));

        product.setSeller(seller);
        product.setCategory(category);

        return productRepository.save(product);
    }

    // Admin adds product on behalf of seller
    public Product addProductAsAdmin(Long sellerId, Long categoryId, Product product) {
        User seller = userService.getUserById(sellerId);
        if (seller.getRole() != User.Role.SELLER) throw new RuntimeException("Seller not found");

        Category category = categoryRepository.findById(categoryId)
                .orElseThrow(() -> new RuntimeException("Category not found"));

        product.setSeller(seller);
        product.setCategory(category);

        return productRepository.save(product);
    }

    // Update product
    public Product updateProductAsSeller(Long sellerId, Long productId, Product updatedProduct, Long categoryId) {
        Product product = productRepository.findById(productId)
                .orElseThrow(() -> new RuntimeException("Product not found"));
        if (!product.getSeller().getId().equals(sellerId)) {
            throw new RuntimeException("Sellers can only update their own products!");
        }

        product.setName(updatedProduct.getName());
        product.setDescription(updatedProduct.getDescription());
        product.setPrice(updatedProduct.getPrice());
        product.setStockQuantity(updatedProduct.getStockQuantity());
        product.setImageUrl(updatedProduct.getImageUrl());

        if (categoryId != null) {
            Category category = categoryRepository.findById(categoryId)
                    .orElseThrow(() -> new RuntimeException("Category not found"));
            product.setCategory(category);
        }

        return productRepository.save(product);
    }

    public Product updateProductAsAdmin(Long productId, Product updatedProduct, Long categoryId) {
        Product product = productRepository.findById(productId)
                .orElseThrow(() -> new RuntimeException("Product not found"));

        product.setName(updatedProduct.getName());
        product.setDescription(updatedProduct.getDescription());
        product.setPrice(updatedProduct.getPrice());
        product.setStockQuantity(updatedProduct.getStockQuantity());
        product.setImageUrl(updatedProduct.getImageUrl());

        if (categoryId != null) {
            Category category = categoryRepository.findById(categoryId)
                    .orElseThrow(() -> new RuntimeException("Category not found"));
            product.setCategory(category);
        }

        return productRepository.save(product);
    }

    // Delete product
    public void deleteProductAsSeller(Long sellerId, Long productId) {
        Product product = productRepository.findById(productId)
                .orElseThrow(() -> new RuntimeException("Product not found"));

        if (!product.getSeller().getId().equals(sellerId)) {
            throw new RuntimeException("Sellers can only delete their own products!");
        }

        productRepository.delete(product);
    }

    public void deleteProductAsAdmin(Long productId) {
        Product product = productRepository.findById(productId)
                .orElseThrow(() -> new RuntimeException("Product not found"));
        productRepository.delete(product);
    }

    // All remaining methods can stay as-is:
    public List<Product> getAllProducts() { return productRepository.findAll(); }
    public List<Product> getProductsBySeller(Long sellerId) {
        User seller = userService.getUserById(sellerId);
        return productRepository.findBySeller(seller);
    }
    public Product getProductById(Long id) { return productRepository.findById(id)
            .orElseThrow(() -> new RuntimeException("Product not found")); }
    public List<Product> getProductsByCategory(Long categoryId) {
        Category category = categoryRepository.findById(categoryId)
                .orElseThrow(() -> new RuntimeException("Category not found"));
        return productRepository.findByCategory(category);
    }
    public List<Product> searchProducts(String keyword) {
        return productRepository.findByNameContainingIgnoreCase(keyword);
    }
    public List<Product> filterByPrice(Double min, Double max) {
        return productRepository.findByPriceBetween(min, max);
    }
    public List<Product> searchAndFilter(String keyword, Double min, Double max) {
        return productRepository.findByNameContainingIgnoreCaseAndPriceBetween(keyword, min, max);
    }
}
//package com.rishi.ecom.service;
//
//import com.rishi.ecom.entity.Category;
//import com.rishi.ecom.entity.Product;
//import com.rishi.ecom.entity.User;
//import com.rishi.ecom.repository.CategoryRepository;
//import com.rishi.ecom.repository.ProductRepository;
//import org.springframework.beans.factory.annotation.Autowired;
//import org.springframework.stereotype.Service;
//
//import java.util.List;
//
//@Service
//public class ProductService {
//
//    @Autowired
//    private ProductRepository productRepository;
//
//    @Autowired
//    private UserService userService;
//
//    @Autowired
//    private CategoryRepository categoryRepository;
//
//    // Seller adds product under category
//    public Product addProduct(Long sellerId, Long categoryId, Product product) {
//        User seller = userService.getUserById(sellerId);
//        if (seller.getRole() != User.Role.SELLER) {
//            throw new RuntimeException("Only sellers can add products!");
//        }
//
//        Category category = categoryRepository.findById(categoryId)
//                .orElseThrow(() -> new RuntimeException("Category not found"));
//
//        product.setSeller(seller);
//        product.setCategory(category);
//
//        return productRepository.save(product);
//    }
//
//    // Seller updates own product / Admin can update any
//    public Product updateProduct(Long requesterId, Long productId, Product updatedProduct, Long categoryId) {
//        User requester = userService.getUserById(requesterId);
//        Product product = productRepository.findById(productId)
//                .orElseThrow(() -> new RuntimeException("Product not found"));
//
//        if (requester.getRole() != User.Role.ADMIN &&
//                !product.getSeller().getId().equals(requester.getId())) {
//            throw new RuntimeException("Access denied!");
//        }
//
//        product.setName(updatedProduct.getName());
//        product.setDescription(updatedProduct.getDescription());
//        product.setPrice(updatedProduct.getPrice());
//        product.setStockQuantity(updatedProduct.getStockQuantity());
//        product.setImageUrl(updatedProduct.getImageUrl());
//
//        if (categoryId != null) {
//            Category category = categoryRepository.findById(categoryId)
//                    .orElseThrow(() -> new RuntimeException("Category not found"));
//            product.setCategory(category);
//        }
//
//        return productRepository.save(product);
//    }
//
//    // Seller deletes own / Admin deletes any
//    public void deleteProduct(Long requesterId, Long productId) {
//        User requester = userService.getUserById(requesterId);
//        Product product = productRepository.findById(productId)
//                .orElseThrow(() -> new RuntimeException("Product not found"));
//
//        if (requester.getRole() != User.Role.ADMIN &&
//                !product.getSeller().getId().equals(requester.getId())) {
//            throw new RuntimeException("Access denied!");
//        }
//
//        productRepository.delete(product);
//    }
//
//    // Get all products
//    public List<Product> getAllProducts() {
//        return productRepository.findAll();
//    }
//
//    // Get products by Seller
//    public List<Product> getProductsBySeller(Long sellerId) {
//        User seller = userService.getUserById(sellerId);
//        return productRepository.findBySeller(seller);
//    }
//
//    // Get product by ID
//    public Product getProductById(Long id) {
//        return productRepository.findById(id)
//                .orElseThrow(() -> new RuntimeException("Product not found"));
//    }
//
//    // Get products by Category
//    public List<Product> getProductsByCategory(Long categoryId) {
//        Category category = categoryRepository.findById(categoryId)
//                .orElseThrow(() -> new RuntimeException("Category not found"));
//        return productRepository.findByCategory(category);
//    }
//
//    // Search by product name
//    public List<Product> searchProducts(String keyword) {
//        return productRepository.findByNameContainingIgnoreCase(keyword);
//    }
//
//    // Filter by price range
//    public List<Product> filterByPrice(Double min, Double max) {
//        return productRepository.findByPriceBetween(min, max);
//    }
//
//    // Combined search + filter
//    public List<Product> searchAndFilter(String keyword, Double min, Double max) {
//        return productRepository.findByNameContainingIgnoreCaseAndPriceBetween(keyword, min, max);
//    }
//}
